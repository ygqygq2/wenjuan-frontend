import{a3 as he,a4 as me,j as e,a5 as xe,a6 as je,a7 as fe,a8 as ge,a9 as ve,aa as Ce,ab as _e,f as g,ac as v,ad as E,i as ke,ae as G,u as z,S as w,af as f,B as h,n as be,ag as V,ah as U,z as ye,ai as we,aj as Ie,ak as Se,al as Ne,am as Le,an as K,b as q,ao as Ee,r as x,I as T,E as De,ap as Te,aq as Pe,D as Oe,ar as Q,a as W,g as X,as as Re,at as Be,m as J,T as Y,X as Ae,au as Z,av as $e,k as He,p as b,aw as Me,ax as Fe,G as Ge}from"./vendor-0bfa93f8.js";import{u as C,g as ee,a as P,c as ze,b as Ve}from"./useGetComponentInfo-457f2789.js";import{r as ne,c as te,p as se,s as Ue,a as Ke,b as $,m as D,i as qe,d as ae,t as ce,M as Qe,u as oe,e as We,f as H,g as Xe,h as Je,j as Ye,k as Ze}from"./index-e92b815d.js";const ie=n=>{const{children:t,items:s,onDragEnd:a}=n,c=he(me(ve,{activationConstraint:{distance:8}}));function r(d){const{active:i,over:u}=d;if(u!=null&&i.id!==u.id){const p=s.findIndex(l=>l.fe_id===i.id),m=s.findIndex(l=>l.fe_id===u.id);a(p,m)}}return e.jsx(xe,{sensors:c,collisionDetection:je,onDragEnd:r,children:e.jsx(fe,{items:s,strategy:ge,children:t})})},le=({id:n,children:t})=>{const{attributes:s,listeners:a,setNodeRef:c,transform:r,transition:d}=Ce({id:n}),i={transform:_e.Transform.toString(r),transition:d};return e.jsx("div",{ref:c,style:i,...s,...a,children:t})};function I(){const{activeElement:n}=document;return!!(n===document.body||n!=null&&n.matches('div[role="button"]'))}function en(){const n=g(),{canUndo:t,canRedo:s}=C();v(["backspace","delete"],()=>{I()&&n(ne())}),v(["ctrl.c","meta.c"],()=>{I()&&n(te())}),v(["ctrl.v","meta.v"],()=>{I()&&n(se())}),v(["uparrow"],()=>{I()&&n(Ue())}),v("downarrow",()=>{I()&&n(Ke())}),v(["ctrl.z","meta.z"],()=>{t&&n(E.undo())},{exactMatch:!0}),v(["ctrl.y","meta.y"],()=>{s&&n(E.redo())})}const nn="_canvas_4r8jc_1",tn="_selected_4r8jc_17",sn="_locked_4r8jc_21",an="_component_4r8jc_7",S={canvas:nn,"component-wrapper":"_component-wrapper_4r8jc_7",selected:tn,locked:sn,component:an};function cn(n){const{type:t,props:s}=n,a=ee(t);if(a==null)return null;const{Component:c}=a;return e.jsx(c,{...s},t)}const on=({loading:n})=>{const{componentList:t,selectedId:s}=C(),a=g();function c(i,u){i.stopPropagation(),a($(u))}if(en(),n)return e.jsx("div",{style:{textAlign:"center",marginTop:"24px"},children:e.jsx(ke,{})});const r=t.map(i=>({...i,id:i.fe_id}));function d(i,u){a(D({oldIndex:i,newIndex:u}))}return e.jsx(ie,{items:r,onDragEnd:d,children:e.jsx("div",{className:S.canvas,children:t.filter(i=>!i.isHidden).map(i=>{const{fe_id:u,isLocked:p}=i,m=S["component-wrapper"],l=S.selected,o=S.locked,j=G({[m]:!0,[l]:u===s,[o]:p});return e.jsx(le,{id:u,children:e.jsx("div",{className:j,onClick:_=>c(_,u),children:e.jsx("div",{className:S.component,children:cn(i)})})},u)})})})};function re(){return z(t=>t.answerRoles)}async function ln(){const n="/api/roles";return await qe.get(n)}const rn="_header_c7j6o_1",dn="_left_c7j6o_16",un="_main_c7j6o_19",pn="_right_c7j6o_23",N={"header-wrapper":"_header-wrapper_c7j6o_1",header:rn,left:dn,main:un,right:pn},hn=()=>{const n=g(),{selectedId:t,componentList:s,selectedComponent:a,copiedComponent:c,canUndo:r,canRedo:d}=C(),{isLocked:i}=a||{},{length:u}=s,p=s.findIndex(pe=>pe.fe_id===t),m=p<=0,l=p>=u-1;function o(){n(ne())}function j(){n(ae({fe_id:t,isHidden:!0}))}function _(){n(ce({fe_id:t}))}function L(){n(te())}function O(){n(se())}function R(){m||n(D({oldIndex:p,newIndex:p-1}))}function B(){l||n(D({oldIndex:p,newIndex:p+1}))}function de(){n(E.undo())}function ue(){n(E.redo())}return e.jsxs(w,{children:[e.jsx(f,{title:"删除",children:e.jsx(h,{shape:"circle",icon:e.jsx(be,{}),onClick:o})}),e.jsx(f,{title:"隐藏",children:e.jsx(h,{shape:"circle",icon:e.jsx(V,{}),onClick:j})}),e.jsx(f,{title:"锁定",children:e.jsx(h,{shape:"circle",icon:e.jsx(U,{}),onClick:_,type:i?"primary":"default"})}),e.jsx(f,{title:"复制",children:e.jsx(h,{shape:"circle",icon:e.jsx(ye,{}),onClick:L})}),e.jsx(f,{title:"粘贴",children:e.jsx(h,{shape:"circle",icon:e.jsx(we,{}),onClick:O,disabled:c===null})}),e.jsx(f,{title:"上移",children:e.jsx(h,{shape:"circle",icon:e.jsx(Ie,{}),onClick:R,disabled:m})}),e.jsx(f,{title:"下移",children:e.jsx(h,{shape:"circle",icon:e.jsx(Se,{}),onClick:B,disabled:l})}),e.jsx(f,{title:"撤消",children:e.jsx(h,{shape:"circle",icon:e.jsx(Ne,{}),onClick:de,disabled:l&&!r})}),e.jsx(f,{title:"重做",children:e.jsx(h,{shape:"circle",icon:e.jsx(Le,{}),onClick:ue,disabled:l&&!d})})]})},{Title:mn}=Y,xn=K.Group,jn=()=>{const n=z(r=>r.pageInfo.title),t=g(),[s,a]=x.useState(!1);function c(r){const d=r.target.value.trim();d&&t(We(d))}return s?e.jsx(T,{value:n,onPressEnter:()=>a(!1),onBlur:()=>a(!1),onChange:c}):e.jsxs(w,{children:[e.jsx(mn,{children:n}),e.jsx(h,{icon:e.jsx(De,{}),type:"text",onClick:()=>a(!0)})]})},fn=()=>{const n=g(),t=re(),[s,a]=x.useState([]),[c,r]=x.useState(t),d=x.useMemo(()=>s.map(o=>({label:o.name,value:o.id})),[s]),i=x.useMemo(()=>s.map(o=>o.id),[s]),u=i.length===c.length,p=c.length>0&&c.length<i.length;x.useEffect(()=>{(async()=>{try{const j=await ln();a(j),r(t||[])}catch(j){console.error("获取角色信息失败:",j)}})()},[t]);const m=o=>{r(o),console.log(o),n(H(o))},l=o=>{r(o.target.checked?i:[]),n(H(o.target.checked?i:[]))};return e.jsx(Te,{content:e.jsxs("div",{children:[e.jsx(K,{indeterminate:p,onChange:l,checked:u,children:e.jsxs(w,{children:["全选",e.jsx(f,{title:"未选择表示所有人可回答",children:e.jsx(Pe,{style:{fontSize:"13px"}})})]})}),e.jsx(Oe,{}),e.jsx(xn,{options:d,value:c,onChange:m})]}),trigger:"click",placement:"bottom",children:e.jsx(h,{children:"问卷回答角色设置"})})},gn=()=>{const{id:n}=Q(),{componentList:t=[]}=C(),s=P(),a=re(),c=W(),r=c.state&&c.state.fetchBackendData,[d,i]=x.useState(0),{loading:u,run:p}=X(async()=>{n&&(await oe(n,{...s,componentList:t,roles:a}),console.log("🚀 ~ file: EditHeader.tsx:134 ~ pageInfo:",s))},{manual:!0}),m=()=>{r&&d===0?i(d+1):p(),i(d+1)};return v(["ctrl.s","meta.s"],l=>{l.preventDefault(),u||m()}),Re(()=>{m()},[s,t,a],{wait:1e3}),e.jsx(h,{onClick:p,disabled:u,icon:u?e.jsx(Be,{}):null,children:"保存"})},vn=()=>{const n=q(),{id:t}=Q(),{componentList:s=[]}=C(),a=P(),{loading:c,run:r}=X(async()=>{t&&await oe(t,{...a,componentList:s,isPublished:!0})},{manual:!0,onSuccess(){J.success("发布成功"),n(`/question/stat/${t}`)}});return e.jsx(h,{type:"primary",onClick:r,disabled:c,children:"发布"})},Cn=()=>{const n=q();return e.jsx("div",{className:N["header-wrapper"],children:e.jsxs("div",{className:N.header,children:[e.jsx("div",{className:N.left,children:e.jsxs(w,{children:[e.jsx(h,{type:"link",icon:e.jsx(Ee,{}),onClick:()=>n(Qe),children:"返回列表"}),e.jsx(jn,{})]})}),e.jsx("div",{className:N.main,children:e.jsx(hn,{})}),e.jsx("div",{className:N.right,children:e.jsxs(w,{children:[e.jsx(fn,{}),e.jsx(gn,{}),e.jsx(vn,{})]})})]})})},_n="_wrapper_1wp05_1",kn="_component_1wp05_13",M={wrapper:_n,component:kn},{Title:bn}=Y;function yn(n){const{title:t,type:s,Component:a,defaultProps:c}=n,r=g(),d=x.useCallback(()=>{r(Xe({fe_id:Ae(),title:t,type:s,props:c}))},[]);return e.jsx("div",{className:M.wrapper,onClick:d,children:e.jsx("div",{className:M.component,children:e.jsx(a,{...c})})},s)}const wn=()=>e.jsx(e.Fragment,{children:ze.map((n,t)=>{const{groupId:s,groupName:a,components:c}=n;return e.jsxs("div",{children:[e.jsx(bn,{level:3,style:{fontSize:"16px",marginTop:t>0?"20px":"0"},children:a}),e.jsx("div",{children:c.map(r=>yn(r))})]},s)})}),In="_wrapper_1vkli_1",Sn="_title_1vkli_6",Nn="_selected_1vkli_10",Ln="_handler_1vkli_13",En="_btn_1vkli_17",y={wrapper:In,title:Sn,selected:Nn,handler:Ln,btn:En},Dn=()=>{const{componentList:n,selectedId:t}=C(),s=g(),[a,c]=x.useState("");function r(l){const o=n.find(j=>j.fe_id===l);if(o&&o.isHidden){J.info("不能选中隐藏的组件");return}if(l!==t){s($(l)),c("");return}c(l)}function d(l){const o=l.target.value.trim();o&&t&&s(Je({fe_id:t,title:o}))}function i(l,o){s(ae({fe_id:l,isHidden:o}))}function u(l){s(ce({fe_id:l}))}const p=n.map(l=>({...l,id:l.fe_id}));function m(l,o){s(D({oldIndex:l,newIndex:o}))}return e.jsx(ie,{items:p,onDragEnd:m,children:n.map(l=>{const{fe_id:o,title:j,isHidden:_,isLocked:L}=l,O=y.title,R=y.selected,B=G({[O]:!0,[R]:o===t});return e.jsx(le,{id:o,children:e.jsxs("div",{className:y.wrapper,children:[e.jsxs("div",{className:B,onClick:()=>r(o),children:[o===a&&e.jsx(T,{value:j,onChange:d,onPressEnter:()=>c(""),onBlur:()=>c("")}),o!==a&&j]}),e.jsx("div",{className:y.handler,children:e.jsxs(w,{children:[e.jsx(h,{size:"small",shape:"circle",className:_?"":y.btn,icon:e.jsx(V,{}),type:_?"primary":"text",onClick:()=>i(o,!_)}),e.jsx(h,{size:"small",shape:"circle",className:L?"":y.btn,icon:e.jsx(U,{}),type:L?"primary":"text",onClick:()=>u(o)})]})})]})},o)})})},Tn=()=>{const n=[{key:"componentLib",label:e.jsxs("span",{children:[e.jsx($e,{}),"组件库"]}),children:e.jsx(wn,{})},{key:"layers",label:e.jsxs("span",{children:[e.jsx(He,{}),"图层"]}),children:e.jsx(Dn,{})}];return e.jsx(Z,{defaultActiveKey:"componentLib",items:n})},F=()=>e.jsx("div",{style:{textAlign:"center"},children:"未选中组件"}),Pn=()=>{const n=g(),{selectedComponent:t}=C();if(t==null)return e.jsx(F,{});const{type:s,props:a,isHidden:c,isLocked:r}=t,d=ee(s);if(d==null)return e.jsx(F,{});function i(p){if(t==null)return;const{fe_id:m}=t;n(Ye({fe_id:m,newProps:p}))}const{PropComponent:u}=d;return e.jsx(u,{...a,onChange:i,disabled:r||c})},{TextArea:A}=T,On=()=>{const n=P(),[t]=b.useForm(),s=g();x.useEffect(()=>{t.setFieldsValue(n)},[n]);function a(){t.getFieldsValue().title&&s(Ze(t.getFieldsValue()))}return e.jsxs(b,{layout:"vertical",initialValues:n,onValuesChange:a,form:t,children:[e.jsx(b.Item,{label:"问卷标题",name:"title",rules:[{required:!0,message:"请输入标题"}],validateTrigger:"onBlur",hasFeedback:!0,children:e.jsx(T,{placeholder:"请输入标题"})}),e.jsx(b.Item,{label:"问卷描述",name:"description",children:e.jsx(A,{placeholder:"问卷描述..."})}),e.jsx(b.Item,{label:"样式代码",name:"css",children:e.jsx(A,{placeholder:"输入 css 样式代码..."})}),e.jsx(b.Item,{label:"脚本代码",name:"js",children:e.jsx(A,{placeholder:"输入 js 脚本代码..."})})]})},Rn=()=>{const[n,t]=x.useState("prop"),{selectedId:s}=C();x.useEffect(()=>{t(s?"prop":"setting")},[s]);const a=r=>{t(r)},c=[{key:"prop",label:e.jsxs("span",{children:[e.jsx(Me,{}),"属性"]}),children:e.jsx(Pn,{})},{key:"setting",label:e.jsxs("span",{children:[e.jsx(Fe,{}),"页面设置"]}),children:e.jsx(On,{})}];return e.jsx(Z,{activeKey:n,items:c,onChange:a})},Bn="_container_1buv5_1",An="_content_1buv5_8",$n="_left_1buv5_18",Hn="_main_1buv5_23",Mn="_right_1buv5_38",k={container:Bn,"content-wrapper":"_content-wrapper_1buv5_8",content:An,left:$n,main:Hn,"canvas-wrapper":"_canvas-wrapper_1buv5_28",right:Mn},Vn=()=>{const n=g(),t=W(),s=t.state&&t.state.fetchBackendData,{loading:a}=Ve(s),[c,r]=x.useState(!1);x.useEffect(()=>{r(a)},[a]);function d(){n($(""))}const{title:i}=P();return Ge(`问卷编辑 - ${i}`),e.jsxs("div",{className:k.container,children:[e.jsx(Cn,{}),e.jsx("div",{className:k["content-wrapper"],children:e.jsxs("div",{className:k.content,children:[e.jsx("div",{className:k.left,children:e.jsx(Tn,{})}),e.jsx("div",{className:k.main,onClick:d,children:e.jsx("div",{className:k["canvas-wrapper"],children:e.jsx(on,{loading:c})})}),e.jsx("div",{className:k.right,children:e.jsx(Rn,{})})]})})]})};export{Vn as default};
